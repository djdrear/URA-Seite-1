<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UNDRA-ENGINE v2.0 – Seite 1 – Ursprung & Blutlinien</title>

  <style>
  :root {
    --bg-main: #050307;
    --bg-panel: #120814;
    --bg-panel-alt: #1b0d24;
    --bg-header: linear-gradient(135deg, #4a0a2f, #1a0b22);
    --bg-header-soft: linear-gradient(135deg, #3a071f, #120614);
    --gold: #d4af37;
    --gold-bright: #f8e7b0;
    --gold-soft: rgba(212, 175, 55, 0.55);
    --gold-shadow: rgba(212, 175, 55, 0.28);
    --accent-red: #d04646;
    --accent-purple: #b46cff;
    --accent-deep: #4a165a;
    --text-main: #f5efe6;
    --text-muted: #a6938a;
    --danger: #ff4b5c;
    --border-strong: rgba(255, 220, 150, 0.8);
    --marble-overlay: radial-gradient(circle at top, rgba(120, 40, 160, 0.35), transparent 55%);
    --font-header: "Palatino Linotype", "Book Antiqua", Palatino, serif;
    --font-body: "Georgia", serif;
  }

  * {
    box-sizing: border-box;
  }

  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    background:
      var(--marble-overlay),
      url("dark-marmor-texture.png") center/cover fixed no-repeat,
      radial-gradient(circle at bottom, #050307 0%, #020107 35%, #000 100%);
    color: var(--text-main);
    font-family: var(--font-body);
  }

  body {
    display: flex;
    justify-content: center;
    padding: clamp(8px, 3vw, 16px);
    align-items: flex-start;
  }

  #app-shell {
    width: 100%;
    max-width: 950px;
    background: linear-gradient(145deg, rgba(8,2,12,0.98), rgba(4,1,7,0.98));
    border-radius: 12px;
    border: 2px solid var(--gold-soft);
    box-shadow:
      0 18px 45px rgba(0,0,0,0.9),
      0 0 24px rgba(40,0,60,0.65);
    overflow: hidden;
    min-height: 100%;
    display: flex;
    flex-direction: column;
  }

  header {
    padding: 14px 16px 10px;
    background: var(--bg-header);
    border-bottom: 1px solid var(--gold-soft);
    position: relative;
    text-align: center;
  }

  header h1 {
    margin: 0;
    font-family: var(--font-header);
    color: var(--gold-bright);
    text-transform: uppercase;
    letter-spacing: 0.32em;
    font-size: 16px;
  }

  #sub-title {
    margin-top: 4px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.16em;
    color: var(--text-muted);
  }

  #engine-tag {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    color: var(--gold-bright);
    padding: 2px 8px;
    border-radius: 999px;
    border: 1px solid rgba(248,231,176,0.5);
    background: linear-gradient(135deg, rgba(40,8,40,0.9), rgba(12,3,20,0.9));
    box-shadow: 0 0 8px rgba(120,0,160,0.6);
  }

  #page-indicator {
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 11px;
    color: var(--text-muted);
  }

  #content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 10px 12px 8px;
  }

  .panel {
    background:
      linear-gradient(145deg, rgba(26,10,32,0.96), rgba(10,4,16,0.98));
    border-radius: 10px;
    border: 1px solid rgba(212,175,55,0.45);
    box-shadow:
      inset 0 0 18px rgba(0,0,0,0.7),
      0 0 10px rgba(60,0,90,0.55);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .panel-header {
    background: var(--bg-header-soft);
    padding: 8px 12px;
    border-bottom: 1px solid rgba(212,175,55,0.4);
    display: flex;
    justify-content: space-between;
    align-items: baseline;
  }

  .panel-title {
    font-family: var(--font-header);
    color: var(--gold-bright);
    text-transform: uppercase;
    letter-spacing: 0.18em;
    font-size: 11px;
  }

  .panel-sub {
    font-size: 11px;
    color: var(--text-muted);
  }

  .identity-grid {
    display: grid;
    grid-template-columns: 190px minmax(0, 1.4fr) 240px;
    gap: 12px;
    padding: 10px 12px 12px;
  }

  @media (max-width: 860px) {
    .identity-grid {
      grid-template-columns: 1fr;
    }
  }

  .portrait-frame {
    width: 170px;
    height: 220px;
    border-radius: 10px;
    border: 2px solid rgba(212,175,55,0.7);
    background:
      radial-gradient(circle at top, rgba(255,255,255,0.05), transparent 55%),
      url("stone-noise.png");
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    box-shadow:
      inset 0 0 30px rgba(0,0,0,0.8),
      0 0 16px rgba(0,0,0,0.9);
    position: relative;
  }

  .portrait-frame img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .portrait-placeholder {
    color: #4b374a;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.2em;
  }

  #upload {
    width: 100%;
    margin-top: 8px;
    font-size: 10px;
    color: var(--text-muted);
  }

  .identity-main {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .name-input {
    font-size: 18px;
    padding: 6px 8px;
    border-radius: 8px;
    border: 1px solid rgba(248,231,176,0.4);
    background: rgba(8,4,12,0.9);
    color: var(--gold-bright);
    width: 100%;
    box-shadow: 0 0 10px rgba(120,0,160,0.4);
  }

  .title-input {
    font-size: 12px;
    padding: 5px 8px;
    border-radius: 6px;
    border: 1px solid rgba(212,175,55,0.35);
    background: rgba(8,4,12,0.9);
    color: var(--text-main);
    width: 100%;
  }

  .name-input:focus,
  .title-input:focus {
    outline: none;
    border-color: var(--accent-purple);
    box-shadow: 0 0 12px rgba(180,108,255,0.8);
    background: rgba(18,8,28,0.96);
  }

  .identity-summary {
  margin-top: 10px;
  font-size: 12px;
  border-radius: 8px;
  border: 1px solid rgba(212,175,55,0.35);
  background:
    radial-gradient(circle at top, rgba(80,0,80,0.35), transparent 60%),
    rgba(0,0,0,0.6);
  padding: 8px 10px;
  min-height: 160px; /* ← NEU */
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

  .identity-summary b {
    color: var(--gold-bright);
  }

  .identity-summary-label {
    color: var(--text-muted);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 4px;
    text-align: center; /* ← NEU */
}

  .radar-box {
    background: rgba(0,0,0,0.55);
    border-radius: 10px;
    border: 1px solid rgba(212,175,55,0.35);
    padding: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow:
      inset 0 0 20px rgba(0,0,0,0.9),
      0 0 10px rgba(100,0,140,0.6);
  }

  #radarCanvas {
    width: 220px;
    height: 220px;
    display: block;
  }

  .attr-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px 20px;
    padding: 10px 12px 8px;
  }

  @media (max-width: 720px) {
    .attr-grid {
      grid-template-columns: 1fr;
    }
  }

  .attr-row {
    display: grid;
    grid-template-columns: minmax(0, 1.3fr) auto 40px auto;
    gap: 6px;
    align-items: center;
    font-size: 12px;
    padding: 3px 4px;
    border-bottom: 1px solid rgba(212,175,55,0.1);
  }

  .attr-name {
    color: var(--text-main);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .val-box {
    background: #000;
    border-radius: 4px;
    border: 1px solid rgba(248,231,176,0.5);
    color: var(--gold-bright);
    font-weight: bold;
    text-align: center;
    padding: 3px 0;
    font-size: 12px;
    box-shadow: 0 0 8px rgba(255,220,150,0.4);
  }

  .btn-step {
    width: 22px;
    height: 22px;
    border-radius: 999px;
    border: 1px solid rgba(212,175,55,0.4);
    background: radial-gradient(circle at 30% 0%, #5b0d2a, #120612);
    color: var(--gold-bright);
    font-size: 11px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: box-shadow 0.15s ease, transform 0.15s ease, background 0.15s ease, opacity 0.15s ease;
  }

  .btn-step:hover {
    box-shadow: 0 0 10px rgba(212,175,55,0.7);
    transform: translateY(-1px);
    background: radial-gradient(circle at 30% 0%, #7d1638, #1a0714);
  }

  .btn-step.disabled {
    opacity: 0.25;
    cursor: not-allowed;
    box-shadow: none;
  }

  .btn-plus {
    background: radial-gradient(circle at 30% 0%, #4a165a, #14071a);
  }

  .btn-plus.glow {
    box-shadow: 0 0 12px rgba(180,108,255,0.9);
    border-color: rgba(248,231,176,0.8);
  }

  .origin-grid {
    display: grid;
    grid-template-columns: 1.1fr 1.1fr 1.1fr;
    gap: 2px;
    background: var(--gold);
    border-top: 1px solid var(--gold-soft);
    border-bottom: 1px solid var(--gold-soft);
  }

  @media (max-width: 860px) {
    .origin-grid {
      grid-template-columns: 1fr;
    }
  }

  .origin-col {
    background:
      radial-gradient(circle at top, rgba(50,10,50,0.85), rgba(12,4,16,0.95));
    padding: 8px 8px 6px;
    max-height: 360px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--gold) #000;
  }

  .origin-col h4 {
    margin: 0 0 6px;
    font-family: var(--font-header);
    color: var(--gold-bright);
    font-size: 12px;
    text-align: center;
    border-bottom: 1px solid rgba(212,175,55,0.3);
    padding-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.16em;
  }

  .check-item {
    display: block;
    padding: 4px 6px;
    cursor: pointer;
    border-radius: 6px;
    border: 1px solid transparent;
    margin-bottom: 3px;
    font-size: 12px;
    color: var(--text-main);
    background: rgba(0,0,0,0.35);
    transition: background 0.15s ease, border 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease;
  }

  .check-item:hover {
    background: rgba(212,175,55,0.12);
    border-color: rgba(212,175,55,0.5);
    box-shadow: 0 0 10px rgba(180,108,255,0.5);
    transform: translateY(-1px);
  }

  .check-item.active {
    background: radial-gradient(circle at top, #7d1638, #180308);
    border-color: var(--border-strong);
    box-shadow: 0 0 12px rgba(255,215,120,0.7);
  }

  footer {
    padding: 8px 10px;
    border-top: 1px solid var(--gold-soft);
    background: linear-gradient(180deg, rgba(10,2,14,0.9), rgba(4,0,8,0.98));
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    font-size: 11px;
  }

  .footer-left,
  .footer-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .footer-center {
    display: flex;
    justify-content: center;
    flex: 1;
  }

  .btn-main {
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid rgba(212,175,55,0.7);
    background: linear-gradient(135deg, #4a0a2f, #1a0b22);
    color: #fff;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 0 12px rgba(180,0,60,0.7);
    text-shadow: 0 0 6px rgba(0,0,0,0.9);
    transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, opacity 0.15s ease;
    white-space: nowrap;
  }

  .btn-main:hover {
    transform: translateY(-1px);
    box-shadow: 0 0 16px rgba(255,215,120,0.9);
    background: linear-gradient(135deg, #7d1638, #2a1034);
  }

  .btn-main:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    box-shadow: none;
  }

  .btn-ghost {
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid rgba(212,175,55,0.4);
    background: linear-gradient(135deg, #241329, #100613);
    color: var(--text-muted);
    font-size: 11px;
    cursor: pointer;
    box-shadow: 0 0 8px rgba(0,0,0,0.8);
  }

  .btn-ghost:hover {
    box-shadow: 0 0 12px rgba(160,100,240,0.7);
    color: var(--gold-bright);
  }

  .footer-info {
    color: var(--text-muted);
  }

  .footer-info span {
    color: var(--gold-bright);
    font-weight: 700;
  }

  .attr-footer {
    padding: 8px 10px 10px;
    border-top: 1px solid rgba(212,175,55,0.25);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
    background: rgba(0,0,0,0.45);
  }

  .pool-label {
    color: var(--text-muted);
  }

  .pool-value {
    color: var(--gold-bright);
    font-weight: bold;
    margin-left: 4px;
  }

  .btn-roll {
    padding: 5px 10px;
    font-size: 11px;
    border-radius: 999px;
    border: 1px solid rgba(248,231,176,0.7);
    background: radial-gradient(circle at 30% 0%, #7d1638, #26030a);
    color: #fff;
    cursor: pointer;
    box-shadow: 0 0 10px rgba(255,120,120,0.8);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 700;
    transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
  }

  .btn-roll:hover {
    transform: translateY(-1px);
    box-shadow: 0 0 14px rgba(255,200,160,0.9);
    background: radial-gradient(circle at 30% 0%, #a01d44, #3a050e);
  }

  .btn-roll:disabled {
    opacity: 0.45;
    cursor: not-allowed;
    box-shadow: none;
  }

  #transient-msg {
    position: fixed;
    left: 50%;
    bottom: 20px;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #2a102f, #130814);
    color: var(--gold-bright);
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid rgba(212,175,55,0.6);
    box-shadow: 0 0 18px rgba(0,0,0,0.9);
    font-size: 11px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 2000;
  }

  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.88);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1500;
    backdrop-filter: blur(4px);
}

  .modal-field {
  margin: 12px 0;
  text-align: left;
}

.modal-field label {
  display: block;
  margin-bottom: 4px;
  color: var(--gold-bright);
  font-size: 14px;
}

.modal-input {
  width: 100%;
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid rgba(212,175,55,0.4);
  background: rgba(20,10,30,0.8);
  color: #f8e7b0;
}

  .modal-title {
    font-family: var(--font-header);
    color: var(--gold-bright);
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.18em;
    margin-bottom: 8px;
  }

  .modal-sub {
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 12px;
  }

  .slot-row {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 10px;
  }

  .slot-btn {
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid rgba(212,175,55,0.6);
    background: radial-gradient(circle at 30% 0%, #4a165a, #150714);
    color: var(--text-main);
    cursor: pointer;
    font-size: 11px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    text-align: left;
    transition: box-shadow 0.15s ease, transform 0.1s ease, background 0.15s ease;
  }

  .slot-btn:hover {
    box-shadow: 0 0 14px rgba(248,231,176,0.9);
    transform: translateY(-1px);
    background: radial-gradient(circle at 30% 0%, #7f2a9f, #1e081f);
  }

  .slot-name {
    font-weight: 600;
    color: var(--gold-bright);
  }

  .slot-meta {
    font-size: 10px;
    color: var(--text-muted);
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 4px;
  }

  .btn-small {
    padding: 4px 10px;
    font-size: 10px;
    border-radius: 999px;
    border: 1px solid rgba(212,175,55,0.6);
    background: linear-gradient(135deg, #221427, #0d050f);
    color: var(--text-muted);
    cursor: pointer;
  }

  .btn-small:hover {
    color: var(--gold-bright);
    box-shadow: 0 0 10px rgba(160,80,240,0.9);
  }

  @media (max-width: 720px) {
    header h1 {
      font-size: 14px;
      letter-spacing: 0.24em;
    }
    #engine-tag {
      display: none;
    }
  }
  </style>
</head>

<body>
  <div id="app-shell">

    <!-- HEADER -->
    <header>
      <div id="engine-tag">UNDRA‑ENGINE v2.0beta</div>
      <h1>Ursprung &amp; Blutlinien</h1>
      <div id="sub-title">Genesis des Heldencharakters</div>
      <div id="page-indicator">Seite 1 von 3</div>
    </header>

    <!-- CONTENT -->
    <div id="content">

      <!-- PANEL 1: Essenz & Antlitz -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Essenz &amp; Antlitz</div>
          <div class="panel-sub" id="hero-preview-sub">Noch ungeschrieben</div>
        </div>

        <div class="identity-grid">

          <!-- Portrait -->
          <div>
            <div class="portrait-frame">
              <img id="preview" src="" alt="" style="display:none;">
              <div id="placeholder" class="portrait-placeholder">PORTRAIT</div>
            </div>
            <input type="file" id="upload" accept="image/*">
          </div>

          <!-- Name / Titel / Vorschau -->
          <div class="identity-main">
            <input type="text" id="in-name" class="name-input" placeholder="Name des Helden">
            <input type="text" id="in-titel" class="title-input" placeholder="Zusatz / Titel (optional)">

            <div class="identity-summary">
              <div class="identity-summary-label">Vorschau</div>

              <div>
                <b id="sum-name">Namenlos</b>
                <span id="sum-title">ohne Titel</span>
              </div>

              <div style="margin-top:4px;">
                <b>Volk:</b> <span id="s-race">–</span>
                <span id="s-sub-wrap" style="display:none;">(<span id="s-sub"></span>)</span><br>

                <b>Profession:</b> <span id="s-prof">–</span><br>

                <b>Besondere Gabe:</b>
                <span id="s-spec" style="font-style:italic; color:var(--gold-bright);">
                  Wähle Rasse &amp; Beruf, um eine Gabe zu erhalten...
                </span>
              </div>
            </div>
          </div>
          
              <!-- Radar -->
        <div class="radar-box">
          <canvas id="radarCanvas" width="220" height="220"></canvas>
        </div>

        </div> <!-- /identity-grid -->

    

      </div> <!-- /PANEL 1 -->

      <!-- PANEL 2: Basisattribute -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Basisattribute</div>
          <div class="panel-sub">Punkte verteilen – Maximum 16 je Attribut</div>
        </div>

        <div id="attr-grid-s1" class="attr-grid"></div>

        <div class="attr-footer">
          <div class="pool-info">
            <span class="pool-label">Punktepool:</span>
            <span class="pool-value" id="p-total">0</span>

            <span class="pool-label">• Verteilte Punkte:</span>
            <span class="pool-value" id="p-used">0</span>

            <span class="pool-label">• Rest:</span>
            <span class="pool-value" id="p-left">0</span>
          </div>

          <button class="btn-roll" id="roll-btn">Punkte auswürfeln</button>
        </div>
      </div> <!-- /PANEL 2 -->

      <!-- PANEL 3: Herkunft & Berufung -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Herkunft &amp; Berufung</div>
          <div class="panel-sub">Rasse • Untergruppe • Profession</div>
        </div>

        <div class="origin-grid">
          <div class="origin-col">
            <h4>Rassen</h4>
            <div id="race-list" class="check-list"></div>
          </div>

          <div class="origin-col">
            <h4>Untergruppen</h4>
            <div id="sub-list" class="check-list"></div>
          </div>

          <div class="origin-col">
            <h4>Professionen</h4>
            <div id="prof-list" class="check-list"></div>
          </div>
        </div>
      </div> <!-- /PANEL 3 -->

    </div> <!-- /content -->

    <!-- FOOTER -->
    <footer id="page-footer">
      <div class="footer-left">
        <button class="btn-ghost" id="btn-cloud-load">Cloud laden</button>
      </div>

      <div class="footer-center">
        <div class="footer-info">
          Attributspiegel – <span>UNDRA‑ENGINE v2.0beta</span>
        </div>
      </div>

      <div class="footer-right">
        <button class="btn-ghost" id="btn-cloud-save">Cloud speichern</button>
        <button class="btn-main" id="btn-next" disabled>Weiter</button>
      </div>
    </footer>

  </div> <!-- /app-shell -->

  <!-- MODAL: PROFESSION -->
  <div id="profession-modal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
      <div class="modal-title">Berufung wählen</div>

      <div class="modal-field">
        <label>Rassenfähigkeit</label>
        <input id="race-ability-input" type="text" class="modal-input">
      </div>

      <div class="modal-field">
        <label>Unterklassen‑Fähigkeit</label>
        <input id="sub-ability-input" type="text" class="modal-input">
      </div>

      <div class="modal-field">
        <label>Bonus‑Attribut</label>
        <select id="attr-bonus-select" class="modal-input"></select>
      </div>

      <div class="modal-actions">
        <button class="btn-ghost" id="btn-prof-cancel">Abbrechen</button>
        <button class="btn-main" id="btn-prof-confirm">Bestätigen</button>
      </div>
    </div>
  </div>

  <!-- MODAL: LEAVE -->
  <div id="leave-modal" class="modal-overlay" style="display:none;">
    <div class="modal-body">
      <div class="modal-title">Charakter verlassen?</div>
      <div class="modal-sub">Dein aktueller Stand wird nicht gespeichert.</div>
      <div class="modal-preview">
  <div><b>HP:</b> <span id="popup-hp">–</span></div>
  <div><b>Attributressourcen:</b> <span id="popup-resource">–</span></div>
  <div><b>SP:</b> <span id="popup-sp">–</span></div>
  <div><b>Abwehr:</b> <span id="popup-abwehr">–</span></div>

  <!-- Diese drei Zeilen waren bisher komplett fehlend -->
  <div><b>Rüstung:</b> <span id="popup-armor">–</span></div>
  <div><b>Geistige Gesundheit:</b> <span id="popup-gg">–</span></div>
  <div><b>Trefferchance:</b> <span id="popup-tc">–</span></div>
</div>

      <div class="modal-actions">
        <button class="btn-ghost" id="btn-leave-cancel">Zurück</button>
        <button class="btn-main" id="btn-leave-confirm">Verlassen</button>
      </div>
    </div>
  </div>

  <!-- MODAL: LOAD -->
  <div id="load-modal" class="modal-overlay" style="display:none;">
    <div class="modal-body">
      <div class="modal-title">Charakter laden</div>

      <div class="modal-field">
        <label>Name</label>
        <input id="load-name" type="text">
      </div>

      <div class="modal-field">
        <label>Titel (optional)</label>
        <input id="load-title" type="text">
      </div>

      <div class="modal-actions">
        <button class="btn-ghost" id="btn-close-load">Abbrechen</button>
        <button class="btn-main" id="btn-load-confirm">Laden</button>
      </div>
    </div>
  </div>

  <!-- TRANSIENT MESSAGE -->
  <div id="transient-msg" class="transient-msg"></div>

<script>
/* ============================================
   UNDRA 2.0 – GLOBALER CHAR-STATE & KONSTANTEN
============================================ */

window.char = {
  name: "", title: "",
  race: "", race2: "", sub: "", prof: "", special: "",
  raceAbility: "", subAbility: "",
  portraitData: null,

  attrs: {},
  bonusApplied: {},
  attrBonusNote: "",

  hp: 0, resource: 0, sp: 0, defense: 0,

  age: "", height: "", weight: "",
  eyes: "", hair: "", voice: "",
  armorDesc: "", specialDesc: "",
  locked: false
};

const ATTRIBUTES = [
  "Mut","Intelligenz","Fingerfertigkeit","Gewandtheit","Körperkraft",
  "Körperbewusstsein","Konstitution","Charisma","Sozialstatus",
  "Geistiger Zustand","Intuition","Angriff","Verteidigung","Abwehrschlag",
  "Fernkampf","Trefferchance","Technik"
];

const ATTR_SHORT = [
  "MU","IN","FF","GE","KK",
  "KB","KO","CH","SS",
  "GZ","IT","AN","VE","AS",
  "FK","TC","TE"
];

const ORIGIN_DATA = {
  "Mensch": { subs: ["Mittelländer", "Tulamiden", "Thorwaler"], profs: ["Ritter", "Dieb", "Händler", "Feuermagier", "Druide"] },
  "Elf": { subs: ["Hochelf", "Waldelf", "Dunkelelf"], profs: ["Wildnisläufer", "Necromant", "Druide", "Sänger"] },
  "Zwerg": { subs: ["Ambosszwerg", "Erzzwerg"], profs: ["Waffenschmied", "Bergmann"] },
  "Ork": { subs: ["Schwarzpelz", "Zholochai"], profs: ["Krieger", "Schamane"] },
  "Halbling": { subs: ["Auen-Halbling","Stadt-Halbling","Wald-Halbling"], profs: ["Späher","Dieb","Koch","Barde","Fernkämpfer"] },
  "Gnom": { subs: ["Felsgnom","Waldgnom","Tüftlergnom"], profs: ["Illusionist","Alchemist","Tüftler","Mechanikus","Trickser"] },
  "Troll": { subs: ["Bergtroll","Höhlentroll","Flusstroll","Felsentroll"], profs: ["Berserker","Schamane","Steinwerfer","Stammeskrieger"] },
  "Goblin": { subs: ["Rotpelz","Stadtgoblin","Wildgoblin","Sumpfgoblin"], profs: ["Kundschafter","Dieb","Hexer","Speerträger","Saboteur"] },
  "Drachengeborener": { subs: ["Flammenbrut","Frostschuppe","Sturmgeboren","Säureschuppe"], profs: ["Krieger","Kampfmagier","Paladin","Drachendisciple"] },
  "Echsenmensch": { subs: ["Sumpfechse","Wüstenechse","Dschungelbrut","Tempelbrut"], profs: ["Speerträger","Schamane","Tempelwächter","Pirscher"] },
  "Tabaxi": { subs: ["Wüsten-Tabaxi","Dschungel-Tabaxi","Schnee-Tabaxi","Steppen-Tabaxi"], profs: ["Jäger","Späher","Klingenmeister","Akrobat","Dieb"] }
};

const SPECIAL_POOL = [
  "Göttlicher Funke","Schattenlauf","Manaschild","Eisenzorn",
  "Blutrunen-Resonanz","Seelenfokus","Nachtschritt","Runenblick",
  "Klingenwirbel","Schildstoß","Ausweichrolle","Kraftschlag",
  "Präzisionshieb","Standfestigkeit","Waffenkenntnis","Kampfhaltung",
  "Taktischer Rückzug","Schnellschritt","Flinke Hände","Schwerer Tritt",
  "Ausdauerstoß","Fokussierter Angriff","Gegenschlag","Wuchtblock",
  "Konzentrationsstoß","Körperbeherrschung","Ruhiger Atem","Spurensinn",
  "Schleichtritt","Scharfer Blick","Schnellziehen","Balancehaltung",
  "Widerstandswille","Klettergriff","Sprintkraft","Zielgenauigkeit",
  "Waffenwechsel","Harter Griff","Schulterramme","Beinfege",
  "Kampfintuition","Durchhaltewille","Schnellkonter","Fester Stand",
  "Überblick","Wachsamkeit","Klingenparade","Rüstungskenntnis",
  "Körperkraft","Zähigkeit","Sturmlauf","Schrittanalyse",
  "Wurfgeschick","Grifftechnik","Stoßkraft","Trittsicherheit",
  "Reaktionsschub","Kampfdisziplin"
];

/* ---------- CLOUD SAVE / LOAD ---------- */
window.undra = window.undra || {};

undra.save = async function (char) {
  const id = `undra_${(char.name || "namenlos").trim().toLowerCase()}_${(char.title || "ohne").trim().toLowerCase()}`
    .replace(/\s+/g, "_");

  try {
    const res = await fetch(`https://undra.djdrear.workers.dev/save/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(char)
    });

    if (!res.ok) {
      console.error("Cloud‑Speichern fehlgeschlagen:", await res.text());
      return false;
    }
    return true;
  } catch (err) {
    console.error("Cloud‑Save Fehler:", err);
    return false;
  }
};

undra.load = async function (name, title = "") {
  const id = `undra_${(name || "namenlos").trim().toLowerCase()}_${(title || "ohne").trim().toLowerCase()}`
    .replace(/\s+/g, "_");

  try {
    const res = await fetch(`https://undra.djdrear.workers.dev/load/${id}`);
    if (!res.ok) {
      console.error("Cloud‑Laden fehlgeschlagen:", await res.text());
      return null;
    }
    const data = await res.json();
    return data || null;
  } catch (err) {
    console.error("Cloud‑Load Fehler:", err);
    return null;
  }
};
const confirmLoad = async () => {
  const name  = document.getElementById("load-name")?.value.trim();
  const title = document.getElementById("load-title")?.value.trim();

  if (!name) {
    showMsg("Bitte einen Namen eingeben.");
    return;
  }

  if (!window.undra || typeof undra.load !== "function") {
    showMsg("Cloud‑Laden ist hier nicht verfügbar.");
    return;
  }

  const data = await undra.load(name, title);

  if (!data) {
    showMsg("Kein Charakter gefunden.");
    return;
  }

  Object.assign(char, data);

  updateUI();
  if (loadModal) loadModal.style.display = "none";
  showMsg("Charakter geladen.");
};
/* ============================================
   UNDRA 2.0 – DOM-REFERENZEN & HELFER
============================================ */

let inName, inTitel, sumName, sumTitle, sRace, sSubWrap, sSub, sProf, sSpec, heroPreviewSub;
let pTotal, pUsed, pLeft;
let raceList, subList, profList;
let rollBtn, btnNext;
let previewImg, placeholder, uploadInput;
let radarCanvas, radarCtx;
let transientMsgEl;
let btnCloudLoad, btnCloudSave;
let loadModal, btnCloseLoad;
let professionModal, raceAbilityInput, subAbilityInput, attrBonusSelectEl, btnProfCancel, btnProfConfirm;
let leaveModal, btnLeaveCancel, btnLeaveConfirm;

let pendingProfession = "";
let transientTimeout = null;

function showMsg(text, ms = 2200) {
  if (!transientMsgEl) return;
  transientMsgEl.textContent = text;
  transientMsgEl.style.opacity = "1";
  if (transientTimeout) clearTimeout(transientTimeout);
  transientTimeout = setTimeout(() => {
    transientMsgEl.style.opacity = "0";
  }, ms);
}

function randomFrom(arr) {
  if (!arr || !arr.length) return "";
  return arr[Math.floor(Math.random() * arr.length)];
}

function clearActiveIn(container) {
  if (!container) return;
  container.querySelectorAll(".check-item").forEach(c => c.classList.remove("active"));
}

function handleUploadChange(e) {
  const file = e.target.files?.[0];
  if (!file) {
    showMsg("Kein Bild ausgewählt.");
    return;
  }

  const reader = new FileReader();
  reader.onload = () => {
    const data = reader.result;
    if (previewImg) {
      previewImg.src = data;
      previewImg.style.display = "block";
    }
    if (placeholder) placeholder.style.display = "none";
    char.portraitData = data;
    showMsg("Portrait übernommen.");
  };
  reader.readAsDataURL(file);
}

/* ---------- VITALWERTE ---------- */
function calculateHP(char) {
  const base = 20;
  const kon = char.attrs?.Konstitution || 0;
  const kk  = char.attrs?.Körperkraft || 0;
  return base + kon * 2 + kk;
}

function calculateDefense(char) {
  const base = 0;
  const gew  = char.attrs?.Gewandtheit || 0;
  const int  = char.attrs?.Intuition || 0;
  return base + Math.floor((gew + int) / 4);
}

function calculateSP(char) {
  const base = 10;
  const int  = char.attrs?.Intelligenz || 0;
  const tec  = char.attrs?.Technik || 0;
  return base + Math.floor((int + tec) / 3);
}

function calculateResource(char) {
  const base = 5;
  const mut  = char.attrs?.Mut || 0;
  return base + Math.floor(mut / 2);
}

function syncVitals() {
  char.hp       = calculateHP(char);
  char.defense  = calculateDefense(char);
  char.sp       = calculateSP(char);
  char.resource = calculateResource(char);
}

function assignArmorFromProfession() {
  const prof = char.prof;
  if (!prof) return;

  const recommended = PROF_ARMOR_MAP[prof] || "Stoff";
  char.recommendedArmor = recommended;
  char.armor = ARMOR_MATERIALS[recommended] || 0;

  // Seite 1: noch keine echte Ausrüstung → kein Malus
  char.armorPenalty = false;

  // Trefferchance bleibt 100% auf Seite 1
  char.hitChance = 100;
}
/* ============================================
   RÜSTUNGSSYSTEM – MATERIAL & PROFESSION-MAP
============================================ */

const ARMOR_MATERIALS = {
  "Stoff": 0,
  "Leder": 1,
  "Gehärtetes Leder": 2,
  "Kette": 3,
  "Schuppe": 4,
  "Platte": 5,
  "Runenplatte": 6,
  "Drachenhaut": 7
};

const PROF_ARMOR_MAP = {
  "Feuermagier": "Stoff",
  "Druide": "Stoff",
  "Illusionist": "Stoff",
  "Alchemist": "Stoff",
  "Necromant": "Stoff",
  "Sänger": "Stoff",
  "Hexer": "Stoff",
  "Kampfmagier": "Leder",

  "Dieb": "Leder",
  "Späher": "Leder",
  "Kundschafter": "Leder",
  "Saboteur": "Leder",
  "Trickser": "Leder",
  "Akrobat": "Leder",

  "Wildnisläufer": "Gehärtetes Leder",
  "Jäger": "Gehärtetes Leder",
  "Pirscher": "Gehärtetes Leder",
  "Fernkämpfer": "Gehärtetes Leder",

  "Krieger": "Kette",
  "Stammeskrieger": "Kette",
  "Speerträger": "Kette",
  "Waffenschmied": "Kette",

  "Ritter": "Platte",
  "Paladin": "Platte",
  "Berserker": "Schuppe",

  "Drachendisciple": "Schuppe",
  "Sturmgeboren": "Schuppe",
  "Frostschuppe": "Schuppe"
};

function fillLeavePopup() {
  // immer vor Anzeige alles neu berechnen
  calculateExtendedVitals();
  assignArmorFromProfession();

  const elHP      = document.getElementById("popup-hp");
  const elRes     = document.getElementById("popup-resource");
  const elSP      = document.getElementById("popup-sp");
  const elAbwehr  = document.getElementById("popup-abwehr");
  const elArmor   = document.getElementById("popup-armor");
  const elGG      = document.getElementById("popup-gg");
  const elTC      = document.getElementById("popup-tc");

  if (elHP)     elHP.textContent     = char.hp;
  if (elRes)    elRes.textContent    = char.attributeResources;
  if (elSP)     elSP.textContent     = char.sp;
  if (elAbwehr) elAbwehr.textContent = char.defense;

  if (elArmor)  elArmor.textContent  = char.recommendedArmor || "–";
  if (elGG)     elGG.textContent     = char.mentalHealth + "%";
  if (elTC)     elTC.textContent     = char.hitChance + "%";
}

function sealCharacter() {
  char.locked = true;
  showMsg("Charakter versiegelt.");
}
/* ============================================
   UNDRA 2.0 – RASSEN / SUB / PROF & PROF-MODAL
============================================ */

function initAttributes() {
  const grid = document.getElementById("attr-grid-s1");
  if (!grid) return;

  if (!char.attrs) char.attrs = {};
  grid.innerHTML = "";

  ATTRIBUTES.forEach(attrName => {
    if (typeof char.attrs[attrName] !== "number") {
      char.attrs[attrName] = 0;
    }

    const row = document.createElement("div");
    row.className = "attr-row";

    const nameSpan = document.createElement("span");
    nameSpan.className = "attr-name";
    nameSpan.textContent = attrName;

    const btnMinus = document.createElement("button");
    btnMinus.className = "btn-step";
    btnMinus.textContent = "▼";
    btnMinus.addEventListener("click", () => modAttr(attrName, -1));

    const valBox = document.createElement("div");
    valBox.className = "val-box";
    valBox.id = "v-" + attrName;
    valBox.textContent = String(char.attrs[attrName]);

    const btnPlus = document.createElement("button");
    btnPlus.className = "btn-step btn-plus";
    btnPlus.id = "plus-" + attrName;
    btnPlus.textContent = "▲";
    btnPlus.addEventListener("click", () => modAttr(attrName, 1));

    row.appendChild(nameSpan);
    row.appendChild(btnMinus);
    row.appendChild(valBox);
    row.appendChild(btnPlus);
    grid.appendChild(row);
  });
}

function modAttr(attrName, delta) {
  const current = char.attrs[attrName] || 0;

  if (delta > 0) {
    const left = (char.pool || 0) - (char.used || 0);
    if (left <= 0) return;
    if (current >= 10) {
      showMsg("Maximum von 10 Punkten in " + attrName + " erreicht.");
      return;
    }
    char.attrs[attrName] = current + 1;
    char.used = (char.used || 0) + 1;
  } else if (delta < 0) {
    if (current <= 0) return;
    char.attrs[attrName] = current - 1;
    char.used = Math.max(0, (char.used || 0) - 1);
  }

  updateUI();
}

/* ---------- RASSEN ---------- */
function initRaces() {
  if (!raceList || !subList || !profList) return;

  raceList.innerHTML = "";
  Object.keys(ORIGIN_DATA).forEach(race => {
    const el = document.createElement("div");
    el.className = "check-item";
    el.textContent = race;
    el.dataset.value = race;
    el.addEventListener("click", () => selectRace(race));
    raceList.appendChild(el);
  });

  raceList.querySelectorAll(".check-item").forEach(el => {
    const val = el.dataset.value;
    if (val === char.race || val === char.race2) {
      el.classList.add("active");
    }
  });

  subList.innerHTML = "";
  profList.innerHTML = "";

  if (char.race) {
    const subs = ORIGIN_DATA[char.race]?.subs || [];
    subs.forEach(sub => {
      const el = document.createElement("div");
      el.className = "check-item";
      el.textContent = sub;
      el.dataset.value = sub;
      el.addEventListener("click", () => selectSub(sub));
      if (sub === char.sub) el.classList.add("active");
      subList.appendChild(el);
    });
  }

  if (!char.race && !char.race2) {
    sSpec.textContent = "Wähle eine Hauptrasse und optional eine Zweitrasse (Mischwesen).";
  } else if (!char.sub || !char.prof) {
    sSpec.textContent = "Wähle eine Untergruppe und eine Profession...";
  }
  sSpec.style.color = "var(--gold-bright)";

  updateUI();
}

function selectRace(race) {
  if (!char.race && !char.race2) {
    char.race = race;
  } else if (char.race === race) {
    char.race = char.race2;
    char.race2 = "";
  } else if (char.race2 === race) {
    char.race2 = "";
  } else if (!char.race2) {
    char.race2 = race;
  } else {
    showMsg("Es können maximal zwei Rassen als Mischwesen gewählt werden.");
    return;
  }

  char.sub = "";
  char.prof = "";
  char.special = "";
  char.raceAbility = "";
  char.subAbility = "";
  char.attrBonusNote = "";
  char.bonusApplied = {};

  clearActiveIn(raceList);
  clearActiveIn(subList);
  clearActiveIn(profList);

  raceList.querySelectorAll(".check-item").forEach(el => {
    const val = el.dataset.value;
    if (val === char.race || val === char.race2) {
      el.classList.add("active");
    }
  });

  subList.innerHTML = "";
  profList.innerHTML = "";

  if (char.race) {
    const subs = ORIGIN_DATA[char.race]?.subs || [];
    subs.forEach(sub => {
      const el = document.createElement("div");
      el.className = "check-item";
      el.textContent = sub;
      el.dataset.value = sub;
      el.addEventListener("click", () => selectSub(sub));
      subList.appendChild(el);
    });

    const profs = ORIGIN_DATA[char.race]?.profs || [];
    profs.forEach(prof => {
      const el = document.createElement("div");
      el.className = "check-item";
      el.textContent = prof;
      el.dataset.value = prof;
      el.addEventListener("click", () => openProfessionModal(prof));
      profList.appendChild(el);
    });
  }

  if (!char.race && !char.race2) {
    sSpec.textContent = "Wähle eine Hauptrasse und optional eine Zweitrasse (Mischwesen).";
  } else if (!char.sub || !char.prof) {
    sSpec.textContent = "Wähle eine Untergruppe und eine Profession...";
  }
  sSpec.style.color = "var(--gold-bright)";

  updateUI();
}

function selectSub(sub) {
  char.sub = sub;

  clearActiveIn(subList);
  clearActiveIn(profList);

  const chosen = subList.querySelector(`[data-value="${sub}"]`);
  if (chosen) chosen.classList.add("active");

  profList.innerHTML = "";

  if (char.race) {
    const profs = ORIGIN_DATA[char.race]?.profs || [];
    profs.forEach(prof => {
      const el = document.createElement("div");
      el.className = "check-item";
      el.textContent = prof;
      el.dataset.value = prof;
      el.addEventListener("click", () => openProfessionModal(prof));
      profList.appendChild(el);
    });
  }

  sSpec.textContent = "Wähle eine Profession, um deine Gabe zu manifestieren.";
  sSpec.style.color = "var(--gold-bright)";

  updateUI();
}

/* ---------- PROFESSION-MODAL ---------- */
function openProfessionModal(prof) {
  pendingProfession = prof;

  if (professionModal)
    professionModal.style.display = "flex";

  if (raceAbilityInput)  raceAbilityInput.value  = char.raceAbility || "";
  if (subAbilityInput)   subAbilityInput.value   = char.subAbility  || "";
  if (attrBonusSelectEl) attrBonusSelectEl.value = char.attrBonusNote || "";

  checkProfessionReady();
}

function closeProfessionModal() {
  if (professionModal)
    professionModal.style.display = "none";
}

function checkProfessionReady() {
  const raceReady  = raceAbilityInput?.value.trim().length > 0;
  const subReady   = subAbilityInput?.value.trim().length > 0;
  const bonusReady = attrBonusSelectEl?.value.length > 0;

  const allReady = raceReady && subReady && bonusReady;

  if (btnProfConfirm)
    btnProfConfirm.disabled = !allReady;
}

function confirmProfession() {
  if (!pendingProfession) {
    closeProfessionModal();
    return;
  }

  char.prof          = pendingProfession;
  char.special       = char.special || randomFrom(SPECIAL_POOL);
  char.raceAbility   = raceAbilityInput?.value.trim() || "";
  char.subAbility    = subAbilityInput?.value.trim()  || "";
  char.attrBonusNote = attrBonusSelectEl?.value || "";

  if (!char.bonusApplied) char.bonusApplied = {};
  if (
    char.attrBonusNote &&
    char.attrs[char.attrBonusNote] != null &&
    !char.bonusApplied[char.attrBonusNote]
  ) {
    char.attrs[char.attrBonusNote] += 1;
    char.bonusApplied[char.attrBonusNote] = true;
  }

  updateUI();
  showMsg("Berufung und Fähigkeiten bestätigt.");
  closeProfessionModal();
}

function markCurrentProfession() {
  if (!char?.prof || !profList) return;
  clearActiveIn(profList);
  const current = profList.querySelector(`[data-value="${char.prof}"]`);
  if (current) current.classList.add("active");
}
/* ============================================
   UNDRA 2.0 – UI, RADAR, POOL, FINAL VALUES
============================================ */

function updateCharFromPage1() {
  char.name    = inName?.value.trim()  || "";
  char.title   = inTitel?.value.trim() || "";

  if (!char.attrs) char.attrs = {};
  document.querySelectorAll("[data-attr]").forEach(el => {
    const key = el.dataset.attr;
    const val = parseInt(el.value || "0", 10);
    char.attrs[key] = val;
  });

  char.age         = document.getElementById("ageInput")?.value.trim() || "";
  char.height      = document.getElementById("heightInput")?.value.trim() || "";
  char.weight      = document.getElementById("weightInput")?.value.trim() || "";
  char.eyes        = document.getElementById("eyesInput")?.value.trim() || "";
  char.hair        = document.getElementById("hairInput")?.value.trim() || "";
  char.voice       = document.getElementById("voiceInput")?.value.trim() || "";
  char.armorDesc   = document.getElementById("armorInput")?.value.trim() || "";
  char.specialDesc = document.getElementById("specialInput")?.value.trim() || "";

  const img = previewImg || document.querySelector("#portrait-box img");
  char.portraitData = img ? img.src : "";
}

function updateUI() {
  if (inName)  char.name  = inName.value.trim();
  if (inTitel) char.title = inTitel.value.trim();

  if (sumName)  sumName.textContent  = char.name || "Namenlos";
  if (sumTitle) sumTitle.textContent = char.title ? ("– " + char.title) : "ohne Titel";

  if (sRace) {
    if (char.race && char.race2) {
      sRace.textContent = `${char.race} / ${char.race2} (Mischwesen)`;
    } else if (char.race) {
      sRace.textContent = char.race;
    } else if (char.race2) {
      sRace.textContent = char.race2;
    } else {
      sRace.textContent = "–";
    }
  }

  if (sSubWrap && sSub) {
    if (char.sub) {
      sSubWrap.style.display = "";
      sSub.textContent = char.sub;
    } else {
      sSubWrap.style.display = "none";
    }
  }

  if (sProf) sProf.textContent = char.prof || "–";

  markCurrentProfession();

  const pool = char.pool || 0;
  const used = char.used || 0;
  const poolLeft = pool - used;

  if (pTotal) pTotal.textContent = pool;
  if (pUsed)  pUsed.textContent  = used;
  if (pLeft)  pLeft.textContent  = poolLeft;

  ATTRIBUTES.forEach(attr => {
    const val = char.attrs[attr] || 0;

    const box = document.getElementById("v-" + attr);
    if (box) box.textContent = val;

    const plusBtn = document.getElementById("plus-" + attr);
    if (plusBtn) {
      const disabled = (poolLeft <= 0 || val >= 10);
      plusBtn.classList.toggle("disabled", disabled);
      plusBtn.classList.toggle("glow", !disabled && pool > 0);
    }
  });

  const parts = [];
  if (char.race && char.race2) parts.push(`${char.race} / ${char.race2}`);
  else if (char.race)          parts.push(char.race);
  else if (char.race2)         parts.push(char.race2);
  if (char.sub)  parts.push(`(${char.sub})`);
  if (char.prof) parts.push(`– ${char.prof}`);
  if (heroPreviewSub) heroPreviewSub.textContent = parts.join(" ");

  const extraLines = [];
  if (char.special)       extraLines.push("Spezial: " + char.special);
  if (char.raceAbility)   extraLines.push(char.raceAbility);
  if (char.subAbility)    extraLines.push(char.subAbility);
  if (char.attrBonusNote) extraLines.push("+1 " + char.attrBonusNote);

  if (extraLines.length > 0) {
    sSpec.innerHTML = extraLines.join("<br>");
    sSpec.style.color = "var(--gold-bright)";
  } else {
    sSpec.textContent = "Wähle Rasse & Beruf, um eine Gabe zu erhalten...";
    sSpec.style.color = "var(--text-muted)";
  }

  const canProceed =
    !!char.name &&
    (char.race || char.race2) &&
    !!char.prof &&
    (char.pool || 0) > 0 &&
    (char.used || 0) > 0;

  if (btnNext) btnNext.disabled = !canProceed;

  drawRadar();
}

function drawRadar() {
  if (!radarCanvas || !radarCtx) return;

  const w = radarCanvas.width;
  const h = radarCanvas.height;
  const cx = w / 2;
  const cy = h / 2;
  const radius = Math.min(w, h) / 2 - 10;

  radarCtx.clearRect(0, 0, w, h);

  const grad = radarCtx.createRadialGradient(cx, cy, 10, cx, cy, radius + 10);
  grad.addColorStop(0, "rgba(180,108,255,0.30)");
  grad.addColorStop(1, "rgba(0,0,0,0.00)");
  radarCtx.fillStyle = grad;
  radarCtx.beginPath();
  radarCtx.arc(cx, cy, radius + 10, 0, Math.PI * 2);
  radarCtx.fill();

  const count = ATTRIBUTES.length;
  const step = (Math.PI * 2) / count;

  radarCtx.strokeStyle = "rgba(212,175,55,0.25)";
  radarCtx.lineWidth = 1;

  for (let i = 0; i < count; i++) {
    const angle = step * i - Math.PI / 2;
    const x = cx + Math.cos(angle) * radius;
    const y = cy + Math.sin(angle) * radius;

    radarCtx.beginPath();
    radarCtx.moveTo(cx, cy);
    radarCtx.lineTo(x, y);
    radarCtx.stroke();

    const tx = cx + Math.cos(angle) * (radius + 12);
    const ty = cy + Math.sin(angle) * (radius + 12);

    radarCtx.fillStyle = "#f8e7b0";
    radarCtx.font = "9px " + (getComputedStyle(document.body).getPropertyValue("font-family") || "serif");
    radarCtx.textAlign = "center";
    radarCtx.textBaseline = "middle";
    radarCtx.fillText(ATTR_SHORT[i], tx, ty);
  }

  radarCtx.beginPath();
  radarCtx.arc(cx, cy, radius, 0, Math.PI * 2);
  radarCtx.strokeStyle = "rgba(248,231,176,0.6)";
  radarCtx.lineWidth = 1;
  radarCtx.stroke();

  radarCtx.beginPath();
  for (let i = 0; i < count; i++) {
    const val = char.attrs[ATTRIBUTES[i]] || 0;
    const factor = val / 10;
    const r = radius * (0.1 + factor * 0.9);
    const angle = step * i - Math.PI / 2;

    const x = cx + Math.cos(angle) * r;
    const y = cy + Math.sin(angle) * r;

    if (i === 0) radarCtx.moveTo(x, y);
    else radarCtx.lineTo(x, y);
  }
  radarCtx.closePath();

  radarCtx.fillStyle = "rgba(208,70,70,0.35)";
  radarCtx.strokeStyle = "#d4af37";
  radarCtx.lineWidth = 2;
  radarCtx.fill();
  radarCtx.stroke();
}

function rollPool() {
  if (char.pool > 0) {
    showMsg("Punkte wurden bereits ausgewürfelt.");
    return;
  }

  const pool = Math.floor(Math.random() * 41) + 20;
  char.pool = pool;
  char.used = 0;

  Object.keys(char.attrs).forEach(a => {
    char.attrs[a] = 0;
  });

  showMsg("Du erhältst " + pool + " Attributpunkte.");
  updateUI();
}

function calculateExtendedVitals() {
  if (!char.attrs) char.attrs = {};
  const a = char.attrs;

  const KK = a["Körperkraft"]       || 0;
  const GE = a["Gewandtheit"]       || 0;
  const KB = a["Körperbewusstsein"] || 0;
  const KO = a["Konstitution"]      || 0;
  const TE = a["Technik"]           || 0;
  const AS = a["Abwehr"] || a["Abwehrschlag"] || 0;

  const hpBase  = 20;
  const hpBonus = Math.round((KK + GE + KB + KO + TE + AS) / 1.75);
  char.hp = hpBase + hpBonus;

  // Attributressourcen = Summe aller vergebenen Attributpunkte
  char.attributeResources = Object.values(a).reduce(
    (sum, v) => sum + (typeof v === "number" ? v : 0),
    0
  );

  const nameLen = (char.name || "").replace(/\s+/g, "").length;
  const attrSum = char.attributeResources;

  // SP = Schicksalspunkte
  char.sp = 500 + nameLen + attrSum + char.hp + AS;

  const IT = a["Intuition"] || 0;
  char.defense = Math.floor((GE + IT) / 4);

  if (typeof char.armor !== "number") char.armor = 0;
  char.mentalHealth = 100;
  if (typeof char.hitChance !== "number") char.hitChance = 100;
}
/* ============================================
   UNDRA 2.0 – INIT & EVENTS (SEITE 1)
============================================ */

document.addEventListener("DOMContentLoaded", () => {
  inName         = document.getElementById("in-name");
  inTitel        = document.getElementById("in-titel");
  sumName        = document.getElementById("sum-name");
  sumTitle       = document.getElementById("sum-title");
  sRace          = document.getElementById("s-race");
  sSubWrap       = document.getElementById("s-sub-wrap");
  sSub           = document.getElementById("s-sub");
  sProf          = document.getElementById("s-prof");
  sSpec          = document.getElementById("s-spec");
  heroPreviewSub = document.getElementById("hero-preview-sub");

  pTotal = document.getElementById("p-total");
  pUsed  = document.getElementById("p-used");
  pLeft  = document.getElementById("p-left");

  raceList = document.getElementById("race-list");
  subList  = document.getElementById("sub-list");
  profList = document.getElementById("prof-list");

  rollBtn = document.getElementById("roll-btn");
  btnNext = document.getElementById("btn-next");

  previewImg  = document.getElementById("preview");
  placeholder = document.getElementById("placeholder");
  uploadInput = document.getElementById("upload");

  radarCanvas = document.getElementById("radarCanvas");
  radarCtx    = radarCanvas ? radarCanvas.getContext("2d") : null;

  transientMsgEl = document.getElementById("transient-msg");

  btnCloudLoad = document.getElementById("btn-cloud-load");
  btnCloudSave = document.getElementById("btn-cloud-save");

  loadModal    = document.getElementById("load-modal");
  btnCloseLoad = document.getElementById("btn-close-load");

  professionModal   = document.getElementById("profession-modal");
  raceAbilityInput  = document.getElementById("race-ability-input");
  subAbilityInput   = document.getElementById("sub-ability-input");
  attrBonusSelectEl = document.getElementById("attr-bonus-select");
  btnProfCancel     = document.getElementById("btn-prof-cancel");
  btnProfConfirm    = document.getElementById("btn-prof-confirm");

  leaveModal      = document.getElementById("leave-modal");
  btnLeaveCancel  = document.getElementById("btn-leave-cancel");
  btnLeaveConfirm = document.getElementById("btn-leave-confirm");

  if (attrBonusSelectEl) {
    attrBonusSelectEl.innerHTML = "";
    ATTRIBUTES.forEach(a => {
      const opt = document.createElement("option");
      opt.value = a;
      opt.textContent = a;
      attrBonusSelectEl.appendChild(opt);
    });
    if (!char.attrBonusNote) attrBonusSelectEl.value = ATTRIBUTES[0];
    else attrBonusSelectEl.value = char.attrBonusNote;
  }

  initAttributes();
  initRaces();
  updateUI();

  if (inName)  inName.addEventListener("input", updateUI);
  if (inTitel) inTitel.addEventListener("input", updateUI);

  if (rollBtn) rollBtn.addEventListener("click", rollPool);
  window.addEventListener("resize", drawRadar);

  if (uploadInput)
    uploadInput.addEventListener("change", handleUploadChange);

  if (char.portraitData && previewImg) {
    previewImg.src = char.portraitData;
    previewImg.style.display = "block";
    if (placeholder) placeholder.style.display = "none";
  }

  if (raceAbilityInput)
    raceAbilityInput.addEventListener("input", checkProfessionReady);
  if (subAbilityInput)
    subAbilityInput.addEventListener("input", checkProfessionReady);
  if (attrBonusSelectEl)
    attrBonusSelectEl.addEventListener("change", checkProfessionReady);

  if (btnProfCancel)
    btnProfCancel.addEventListener("click", closeProfessionModal);
  if (btnProfConfirm)
    btnProfConfirm.addEventListener("click", confirmProfession);

  async function saveCharacterToCloud() {
    updateCharFromPage1();
    syncVitals();
    calculateExtendedVitals();
    const ok = await undra.save(char);
    showMsg(ok ? "Charakter in der UNDRA‑Cloud gespeichert." : "Fehler beim Cloud‑Speichern.");
  }

  async function confirmLoad() {
    const name  = document.getElementById("load-name")?.value.trim();
    const title = document.getElementById("load-title")?.value.trim();

    if (!name) {
      showMsg("Bitte einen Namen eingeben.");
      return;
    }

    const data = await undra.load(name, title);
    if (!data) {
      showMsg("Kein Charakter gefunden.");
      return;
    }

    Object.assign(char, data);

    if (inName)  inName.value  = char.name  || "";
    if (inTitel) inTitel.value = char.title || "";

    if (previewImg && char.portraitData) {
      previewImg.src = char.portraitData;
      previewImg.style.display = "block";
      if (placeholder) placeholder.style.display = "none";
    }

    initAttributes();
    initRaces();
    updateUI();

    if (loadModal) loadModal.style.display = "none";
    showMsg("Charakter geladen.");
  }

  const openLoadModal = () => {
    if (loadModal) loadModal.style.display = "flex";
  };
  const closeLoadModal = () => {
    if (loadModal) loadModal.style.display = "none";
  };

  if (btnCloudSave)
    btnCloudSave.addEventListener("click", saveCharacterToCloud);

  if (btnCloudLoad)
    btnCloudLoad.addEventListener("click", openLoadModal);

  if (btnCloseLoad)
    btnCloseLoad.addEventListener("click", closeLoadModal);

  const btnLoadConfirm = document.getElementById("btn-load-confirm");
  if (btnLoadConfirm)
    btnLoadConfirm.addEventListener("click", confirmLoad);

btnNext.addEventListener("click", () => {
  updateCharFromPage1();     // 1. Werte aus der Seite holen
  syncVitals();              // 2. HP, SP, Abwehr, Ressourcen, Armor, TC
  fillLeavePopup();          // 3. Pop-up füllen
  leaveModal.style.display = "flex"; // 4. Anzeigen
});
  

  if (btnLeaveConfirm) {
    btnLeaveConfirm.addEventListener("click", () => {
      updateCharFromPage1();
      syncVitals();
      calculateExtendedVitals();
      sealCharacter();
      window.location.href = "https://djdrear.github.io/Seite-2/";
    });
  }

  if (btnLeaveCancel)
    btnLeaveCancel.addEventListener("click", () => {
      if (leaveModal) leaveModal.style.display = "none";
    });
});
</script>
</body>
</html>
